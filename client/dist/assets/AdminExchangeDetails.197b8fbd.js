import{ak as e,u as s,a as t,j as a,C as n,B as r,F as i,X as o,a3 as d,q as l,al as c,k as h,ar as u,au as x,av as p,ax as m,T as j,ay as g,a2 as b,ab as v,W as f,D as y,a0 as w,am as I,an as S,ao as k,ap as A,aq as C,aA as W,aL as D,aM as P,aN as F,aK as B,aB as T,aC as q,v as R,aO as L,a5 as z,aP as E,aQ as $,V as N,ac as M}from"./vendor.17cb6192.js";import{u as O,a as U}from"./index.5c90ee8a.js";import{I as G,E as Y}from"./ExchangeStatusStepper.01ca9fbc.js";import"./firebase.99e0e815.js";const H=({status:e})=>{switch(e){case"approved":return a.jsx(N,{icon:a.jsx(f,{}),label:"Approved",color:"success"});case"declined":return a.jsx(N,{icon:a.jsx(M,{}),label:"Declined",color:"error"});case"completed":return a.jsx(N,{icon:a.jsx(f,{}),label:"Completed",color:"success",sx:{bgcolor:"#9c27b0",color:"white"}});default:return a.jsx(N,{icon:a.jsx(v,{}),label:"Pending",color:"warning"})}};function K(){const{id:N}=e(),{currentUser:M}=O(),K=s(),[Q,V]=t.useState(!0),[X,J]=t.useState(""),[Z,_]=t.useState(null),[ee,se]=t.useState(""),[te,ae]=t.useState(""),[ne,re]=t.useState(!1),[ie,oe]=t.useState(""),[de,le]=t.useState([]),[ce,he]=t.useState(!1),[ue,xe]=t.useState(""),[pe,me]=t.useState(""),[je,ge]=t.useState(!1),[be,ve]=t.useState(""),[fe,ye]=t.useState(!1),[we,Ie]=t.useState(!1),[Se,ke]=t.useState(!1),Ae=t.useCallback((async()=>{var e,s;try{V(!0),J("");const e=await M.getIdToken(),s=await U.get(`/api/admin/exchange-requests/${N}`,{headers:{Authorization:`Bearer ${e}`}});_(s.data),se(s.data.status),ae(s.data.adminFeedback||""),xe(s.data.creditAmount>0?s.data.creditAmount.toString():""),s.data.warehouseId&&oe(s.data.warehouseId)}catch(t){J((null==(s=null==(e=t.response)?void 0:e.data)?void 0:s.error)||"Failed to load exchange details")}finally{V(!1)}}),[N,M]),Ce=t.useCallback((async()=>{try{he(!0);const e=await M.getIdToken(),s=(await U.get("/api/admin/warehouses",{headers:{Authorization:`Bearer ${e}`}})).data.filter((e=>!1!==e.isActive));le(s),1!==s.length||ie||oe(s[0].id)}catch(e){}finally{he(!1)}}),[M,ie]);t.useEffect((()=>{Ae()}),[Ae]),t.useEffect((()=>{Z&&"pending"===Z.status&&Ce()}),[Z,Ce]);const We=async()=>{var e,s;try{ye(!0),J("");const e=await M.getIdToken(),s=await U.put(`/api/admin/exchange-requests/${N}/transit`,{transitStatus:"received",adminNote:be},{headers:{Authorization:`Bearer ${e}`}});_(s.data),ve("")}catch(t){J((null==(s=null==(e=t.response)?void 0:e.data)?void 0:s.error)||"Failed to update transit status")}finally{ye(!1)}};return Q?a.jsx(n,{maxWidth:"md",sx:{mt:4},children:a.jsx(r,{sx:{display:"flex",justifyContent:"center",my:8},children:a.jsx(i,{})})}):Z?a.jsxs(n,{maxWidth:"lg",children:[X&&a.jsx(d,{severity:"error",sx:{mb:3},children:X}),a.jsxs(r,{sx:{mb:3,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[a.jsx(l,{component:h,to:"/admin/exchange-requests",startIcon:a.jsx(c,{}),children:"Back to Exchange Requests"}),a.jsx(r,{children:a.jsx(l,{variant:"outlined",startIcon:a.jsx(u,{}),color:"error",onClick:()=>Ie(!0),sx:{mr:1},children:"Delete"})})]}),a.jsxs(x,{open:we,onClose:()=>Ie(!1),children:[a.jsx(p,{children:"Confirm Delete"}),a.jsx(m,{children:a.jsx(j,{children:"Are you sure you want to delete this exchange request? This cannot be undone."})}),a.jsxs(g,{children:[a.jsx(l,{onClick:()=>Ie(!1),children:"Cancel"}),a.jsx(l,{onClick:async()=>{var e,s;try{ke(!0),J("");const e=await M.getIdToken();await U.delete(`/api/admin/exchange-requests/${N}`,{headers:{Authorization:`Bearer ${e}`}}),K("/admin/exchange-requests")}catch(t){J((null==(s=null==(e=t.response)?void 0:e.data)?void 0:s.error)||"Failed to delete exchange")}finally{ke(!1)}},color:"error",startIcon:a.jsx(u,{}),children:"Delete"})]})]}),Se&&a.jsx(r,{sx:{width:"100%",mb:2},children:a.jsx(b,{})}),a.jsxs(o,{elevation:3,sx:{p:3,borderRadius:2,mb:3},children:["pending"===Z.status&&a.jsx(r,{sx:{mb:3},children:a.jsxs(r,{sx:{display:"flex",alignItems:"center",p:2,bgcolor:"#fff9c4",borderRadius:1},children:[a.jsx(v,{sx:{color:"warning.main",mr:1}}),a.jsx(j,{variant:"body1",children:"This exchange request is waiting for your review."})]})}),"approved"===Z.status&&!Z.shippingDetails&&a.jsx(r,{sx:{mb:3},children:a.jsxs(r,{sx:{display:"flex",alignItems:"center",p:2,bgcolor:"#e8f5e9",borderRadius:1},children:[a.jsx(f,{sx:{color:"success.main",mr:1}}),a.jsx(j,{variant:"body1",children:"This request has been approved. Waiting for customer to submit shipping details."})]})}),a.jsxs(r,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[a.jsx(j,{variant:"h5",component:"h1",gutterBottom:!0,children:"Exchange Request"}),a.jsx(H,{status:Z.status})]}),a.jsx(y,{sx:{mb:3}}),a.jsxs(w,{container:!0,spacing:3,children:[a.jsxs(w,{item:!0,xs:12,md:8,children:[a.jsx(I,{component:o,variant:"outlined",children:a.jsx(S,{children:a.jsxs(k,{children:[a.jsxs(A,{children:[a.jsx(C,{component:"th",scope:"row",sx:{fontWeight:"bold"},children:"Request ID"}),a.jsx(C,{children:Z.id})]}),a.jsxs(A,{children:[a.jsx(C,{component:"th",scope:"row",sx:{fontWeight:"bold"},children:"Customer"}),a.jsxs(C,{children:[Z.customerName||"Unknown",Z.customerEmail&&a.jsxs(r,{children:["(",Z.customerEmail,")"]})]})]}),a.jsxs(A,{children:[a.jsx(C,{component:"th",scope:"row",sx:{fontWeight:"bold"},children:"Status"}),a.jsx(C,{children:a.jsx(H,{status:Z.status})})]}),a.jsxs(A,{children:[a.jsx(C,{component:"th",scope:"row",sx:{fontWeight:"bold"},children:"Submitted"}),a.jsx(C,{children:new Date(Z.createdAt).toLocaleString()})]}),a.jsxs(A,{children:[a.jsx(C,{component:"th",scope:"row",sx:{fontWeight:"bold"},children:"Last Updated"}),a.jsx(C,{children:new Date(Z.updatedAt).toLocaleString()})]}),Z.shippingDetails&&a.jsxs(a.Fragment,{children:[a.jsxs(A,{children:[a.jsx(C,{component:"th",scope:"row",sx:{fontWeight:"bold"},children:"Shipping Carrier"}),a.jsx(C,{children:Z.shippingDetails.carrierName})]}),a.jsxs(A,{children:[a.jsx(C,{component:"th",scope:"row",sx:{fontWeight:"bold"},children:"Tracking Number"}),a.jsx(C,{children:Z.shippingDetails.trackingNumber})]}),a.jsxs(A,{children:[a.jsx(C,{component:"th",scope:"row",sx:{fontWeight:"bold"},children:"Shipping Date"}),a.jsx(C,{children:new Date(Z.shippingDetails.shippingDate).toLocaleDateString()})]})]}),Z.shippingDetails&&Z.warehouseInfo&&a.jsxs(A,{children:[a.jsx(C,{component:"th",scope:"row",sx:{fontWeight:"bold"},children:"Shipped To"}),a.jsxs(C,{children:[Z.warehouseInfo.name,", ",Z.warehouseInfo.city]})]}),Z.creditAmount>0&&a.jsxs(A,{children:[a.jsx(C,{component:"th",scope:"row",sx:{fontWeight:"bold"},children:"Assigned Loyalty Points"}),a.jsxs(C,{children:["₹",Z.creditAmount]})]}),Z.totalLoyaltyPoints>0&&a.jsxs(A,{children:[a.jsx(C,{component:"th",scope:"row",sx:{fontWeight:"bold"},children:"Total Loyalty Points"}),a.jsxs(C,{children:["₹",Z.totalLoyaltyPoints]})]})]})})}),a.jsx(r,{sx:{mt:4},children:a.jsx(G,{images:Z.images||[],title:"Product Images",maxHeight:300,columns:3,emptyMessage:"No product images provided"})})]}),a.jsxs(w,{item:!0,xs:12,md:4,children:[a.jsx(j,{variant:"h6",gutterBottom:!0,children:"Product Description"}),a.jsx(j,{variant:"body2",paragraph:!0,children:Z.description}),Z.adminFeedback&&a.jsxs(a.Fragment,{children:[a.jsx(j,{variant:"h6",gutterBottom:!0,sx:{mt:3},children:"Admin Feedback"}),a.jsx(o,{variant:"outlined",sx:{p:2,bgcolor:"#f9f9f9"},children:a.jsx(j,{variant:"body2",children:Z.adminFeedback})})]})]})]})]}),a.jsxs(o,{elevation:3,sx:{p:3,borderRadius:2,mb:3},children:[a.jsx(j,{variant:"h5",component:"h2",gutterBottom:!0,children:"Exchange Process"}),"pending"===Z.status?a.jsxs(r,{sx:{mt:2},children:[a.jsx(W,{component:"fieldset",sx:{mb:2},children:a.jsxs(D,{row:!0,name:"status",value:ee,onChange:e=>se(e.target.value),children:[a.jsx(P,{value:"approved",control:a.jsx(F,{}),label:"Approve"}),a.jsx(P,{value:"declined",control:a.jsx(F,{}),label:"Decline"})]})}),"approved"===ee&&a.jsxs(r,{sx:{mb:3,p:2,bgcolor:"#e8f5e9",borderRadius:1},children:[a.jsxs(j,{variant:"subtitle1",gutterBottom:!0,sx:{display:"flex",alignItems:"center"},children:[a.jsx(B,{sx:{mr:1}}),"Select Warehouse for Shipping"]}),a.jsx(j,{variant:"body2",sx:{mb:2,color:"text.secondary"},children:"The customer will be instructed to ship their product to this warehouse address."}),a.jsxs(W,{fullWidth:!0,required:!0,error:"approved"===ee&&!ie,children:[a.jsx(T,{id:"warehouse-select-label",children:"Warehouse"}),a.jsx(q,{labelId:"warehouse-select-label",value:ie,onChange:e=>oe(e.target.value),label:"Warehouse",disabled:ce,children:0===de.length?a.jsx(R,{disabled:!0,value:"",children:ce?"Loading warehouses...":"No warehouses available"}):de.map((e=>a.jsxs(R,{value:e.id,children:[e.name," - ",e.city,", ",e.state]},e.id)))}),"approved"===ee&&!ie&&a.jsx(L,{error:!0,children:"Required for approval"})]}),0===de.length&&!ce&&a.jsx(r,{sx:{mt:2},children:a.jsxs(d,{severity:"warning",children:[a.jsx(j,{variant:"body2",children:"You need to add a warehouse first. Go to the Warehouse Manager in the Admin Dashboard."}),a.jsx(l,{size:"small",component:h,to:"/admin/dashboard?tab=5",sx:{mt:1},children:"Go to Warehouse Manager"})]})})]}),a.jsx(z,{label:"Admin Feedback",multiline:!0,rows:3,fullWidth:!0,value:te,onChange:e=>ae(e.target.value),variant:"outlined",placeholder:"Provide feedback to the customer",sx:{mb:2}}),a.jsx(l,{variant:"contained",color:"primary",startIcon:ne?a.jsx(i,{size:20,color:"inherit"}):a.jsx(E,{}),onClick:async()=>{var e,s;if(ee!==Z.status)if("approved"!==ee||ie)try{re(!0),J("");const e=await M.getIdToken(),s=await U.put(`/api/admin/exchange-requests/${N}/status`,{status:ee,adminFeedback:te,warehouseId:"approved"===ee?ie:void 0},{headers:{Authorization:`Bearer ${e}`}});_(s.data),se(s.data.status),ae(s.data.adminFeedback||"")}catch(t){J((null==(s=null==(e=t.response)?void 0:e.data)?void 0:s.error)||"Failed to update status")}finally{re(!1)}else J("Please select a warehouse for shipping the product")},disabled:ne||ee===Z.status,children:"Submit Decision"})]}):a.jsxs(a.Fragment,{children:[a.jsx(Y,{exchange:Z,isAdmin:!0,onReceiveClick:()=>{Z.shippingDetails&&"received"!==Z.transitStatus&&We()},onCreditClick:()=>{if("received"===Z.transitStatus&&!Z.creditAmount){const e=document.getElementById("credit-amount-field");e&&e.focus()}},onCompleteClick:()=>{"received"===Z.transitStatus&&Z.creditAmount>0&&(async()=>{var e,s;try{if(re(!0),J(""),!Z.creditAmount||Z.creditAmount<=0)return J("You must assign credit before completing the exchange"),void re(!1);const e=await M.getIdToken(),s=await U.put(`/api/admin/exchange-requests/${N}/status`,{status:"completed",adminFeedback:"Exchange process completed."},{headers:{Authorization:`Bearer ${e}`}});_(s.data),se(s.data.status)}catch(t){J((null==(s=null==(e=t.response)?void 0:e.data)?void 0:s.error)||"Failed to complete exchange")}finally{re(!1)}})()}}),"approved"===Z.status&&Z.shippingDetails&&"received"!==Z.transitStatus&&a.jsxs(r,{sx:{mt:3,p:2,border:"1px solid #e0e0e0",borderRadius:1,bgcolor:"#f5f5f5"},children:[a.jsx(j,{variant:"subtitle1",gutterBottom:!0,children:"Mark as Received"}),a.jsx(z,{label:"Notes (Optional)",fullWidth:!0,value:be,onChange:e=>ve(e.target.value),variant:"outlined",size:"small",sx:{mb:2}}),a.jsx(l,{variant:"contained",color:"primary",startIcon:fe?a.jsx(i,{size:20,color:"inherit"}):a.jsx(f,{}),onClick:We,disabled:fe,children:"Mark as Received"})]}),"approved"===Z.status&&"received"===Z.transitStatus&&!Z.creditAmount&&a.jsxs(r,{sx:{mt:3,p:2,border:"1px solid #e0e0e0",borderRadius:1,bgcolor:"#f5f5f5"},children:[a.jsx(j,{variant:"subtitle1",gutterBottom:!0,children:"Assign Loyalty Points"}),a.jsx(j,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"The loyalty points you assign will be added to the customer's existing points balance in Shopify."}),a.jsx(z,{id:"credit-amount-field",label:"Loyalty Points to Add (₹)",type:"number",fullWidth:!0,value:ue,onChange:e=>xe(e.target.value),variant:"outlined",size:"small",InputProps:{inputProps:{min:0,step:"1"}},sx:{mb:2}}),a.jsx(z,{label:"Points Assignment Note (Optional)",fullWidth:!0,value:pe,onChange:e=>me(e.target.value),variant:"outlined",size:"small",sx:{mb:2}}),a.jsx(l,{variant:"contained",color:"primary",startIcon:je?a.jsx(i,{size:20,color:"inherit"}):a.jsx($,{}),onClick:async()=>{var e,s;try{if(ge(!0),J(""),!ue||isNaN(parseFloat(ue))||parseFloat(ue)<0)return J("Please enter a valid credit amount"),void ge(!1);const e=Math.round(parseFloat(ue)),s=await M.getIdToken(),t=await U.put(`/api/admin/exchange-requests/${N}/credit`,{creditAmount:e,additionalFeedback:pe},{headers:{Authorization:`Bearer ${s}`}});_(t.data),xe(t.data.creditAmount.toString()),me("")}catch(t){J((null==(s=null==(e=t.response)?void 0:e.data)?void 0:s.error)||"Failed to assign loyalty points")}finally{ge(!1)}},disabled:je,children:"Assign Loyalty Points"})]})]})]}),"completed"===Z.status&&a.jsxs(o,{elevation:3,sx:{p:3,borderRadius:2,bgcolor:"success.light"},children:[a.jsx(j,{variant:"h5",component:"h2",gutterBottom:!0,sx:{color:"success.dark"},children:"Exchange Completed Successfully"}),a.jsxs(j,{variant:"body1",sx:{color:"success.dark"},children:["This exchange has been successfully completed. The customer has been assigned ₹",Z.creditAmount.toFixed(2)," in store credit."]})]}),"approved"===Z.status&&Z.warehouseInfo&&!Z.shippingDetails&&a.jsxs(o,{elevation:3,sx:{p:3,borderRadius:2,mb:3},children:[a.jsx(j,{variant:"h6",gutterBottom:!0,children:"Customer Ships To This Address"}),a.jsxs(w,{container:!0,spacing:2,children:[a.jsxs(w,{item:!0,xs:12,md:6,children:[a.jsx(j,{variant:"body2",sx:{fontWeight:"bold"},children:Z.warehouseInfo.name}),a.jsx(j,{variant:"body2",children:Z.warehouseInfo.addressLine1}),Z.warehouseInfo.addressLine2&&a.jsx(j,{variant:"body2",children:Z.warehouseInfo.addressLine2}),a.jsxs(j,{variant:"body2",children:[Z.warehouseInfo.city,", ",Z.warehouseInfo.state," ",Z.warehouseInfo.postalCode]}),a.jsx(j,{variant:"body2",children:Z.warehouseInfo.country})]}),(Z.warehouseInfo.contactPerson||Z.warehouseInfo.contactPhone)&&a.jsxs(w,{item:!0,xs:12,md:6,children:[a.jsx(j,{variant:"body2",sx:{fontWeight:"bold"},children:"Contact Information"}),Z.warehouseInfo.contactPerson&&a.jsx(j,{variant:"body2",children:Z.warehouseInfo.contactPerson}),Z.warehouseInfo.contactPhone&&a.jsx(j,{variant:"body2",children:Z.warehouseInfo.contactPhone})]})]})]})]}):a.jsx(n,{maxWidth:"md",sx:{mt:4},children:a.jsxs(o,{elevation:3,sx:{p:4,borderRadius:2},children:[a.jsx(d,{severity:"error",children:"Exchange request not found or you don't have permission to view it."}),a.jsx(r,{sx:{mt:3},children:a.jsx(l,{variant:"contained",startIcon:a.jsx(c,{}),component:h,to:"/admin/dashboard",children:"Back to Dashboard"})})]})})}export{K as default};
